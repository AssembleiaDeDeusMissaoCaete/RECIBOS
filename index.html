<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gerador de Recibo com Envio Controlado</title>
  <!-- Fonte manuscrita -->
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
  <!-- html2pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f0f0f0; padding: 20px; }
    /* Recibo com largura A4 proporcional */
    #recibo {
      width: 210mm;
      max-width: 100%;
      margin: auto;
      background: white;
      padding: 20mm;
      border: 1px solid #333;
      position: relative;
      line-height: 1.6;
      box-sizing: border-box;
    }
    #recibo h1 { font-size: 24px; margin-bottom: 10mm; }
    .receipt-input {
      border: none;
      border-bottom: 1px solid #333;
      background: transparent;
      font-family: 'Patrick Hand', cursive;
      font-style: italic;
      font-size: 1.1em;
      padding: 2px 4px;
      margin: 0 4px;
      box-sizing: border-box;
    }
    .small { width: 50mm; }
    .medium { width: 80mm; }
    .large { width: 140mm; }
    .full { width: calc(100% - 20px); }
    #recibo .valor-numero {
      position: absolute;
      top: 20mm;
      right: 20mm;
      font-size: 18px;
      font-weight: bold;
      font-family: 'Patrick Hand', cursive;
      font-style: italic;
    }
    .assinatura { margin-top: 20mm; }
    .assinatura-label { display: block; margin-bottom: 2mm; }
    #signature-pad {
      border: 1px solid #333;
      width: 100%;
      height: 30mm;
      touch-action: none;
      box-sizing: border-box;
    }
    button {
      margin-top: 8px;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
    }
    #clear-signature { background: #dc3545; color: #fff; }
    #send-button { background: #007bff; color: #fff; margin-right: 8px; }
    #print-button { background: #28a745; color: #fff; }
    @media print { button { display: none; } }
  </style>
</head>
<body>
  <div id="recibo">
    <h1>
      RECIBO N.º <input type="text" id="numeroRecibo" class="receipt-input small" readonly>
    </h1>
    <div class="valor-numero">
      R$ <input type="text" id="valorNumero" class="receipt-input small" readonly>
    </div>
    <p>
      Recebi(emos) de <strong>Assembleia de Deus – Caeté – MG</strong>, residente à Rua do Rosário, nº 92 – Bairro Centro – CNPJ 12.086.579/0001-36,
      a importância de <input type="text" id="valorExtenso" class="receipt-input large" readonly>
    </p>
    <p>
      Proveniente de <input type="text" id="provenienteInput" class="receipt-input medium" readonly>
    </p>
    <p>
      Para maior clareza firmo o presente.
    </p>
    <p>
      Caeté, <input type="text" id="dataInput" class="receipt-input medium" readonly>
    </p>
    <div class="assinatura">
      <label class="assinatura-label">Assinatura:</label>
      <canvas id="signature-pad"></canvas>
      <button id="clear-signature">Limpar Assinatura</button>
      <div>
        <span class="assinatura-label">Nome:</span>
        <input type="text" id="assinanteNome" class="receipt-input full" placeholder="Nome completo">
      </div>
      <div>
        <span class="assinatura-label">CPF/CNPJ:</span>
        <input type="text" id="assinanteCPF" class="receipt-input full" placeholder="CPF ou CNPJ">
      </div>
    </div>
    <button id="send-button">Enviar o recibo</button>
    <button id="print-button" onclick="window.print()">Imprimir Recibo</button>
  </div>

  <script>
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzPmk1f3zZgPPOU2o4dgrl630iAAYRxK_paT6j2pkVhU52EIpqwseyaCvmkMSmw2pAM1w/exec';

    document.addEventListener('DOMContentLoaded', () => {
      autoFillDateNumber();
      preencherCampos();
      setupCanvas();
      document.getElementById('send-button').addEventListener('click', sendToDrive);
    });

    function autoFillDateNumber() {
      const now = new Date();
      const pad = n => String(n).padStart(2, '0');
      const d = pad(now.getDate()), m = pad(now.getMonth() + 1), y = now.getFullYear();
      const hh = pad(now.getHours()), mm = pad(now.getMinutes()), ss = pad(now.getSeconds());
      document.getElementById('numeroRecibo').value = `${d}${m}${y}${hh}${mm}${ss}`;
      const months = ['janeiro','fevereiro','março','abril','maio','junho','julho','agosto','setembro','outubro','novembro','dezembro'];
      document.getElementById('dataInput').value =
        `${d} de ${months[now.getMonth()]} de ${y} às ${hh}h${mm}m${ss}s`;
    }

    function preencherCampos() {
      const p = new URLSearchParams(window.location.search);
      if (p.has('valor')) {
        const v = p.get('valor');
        document.getElementById('valorNumero').value = v;
        document.getElementById('valorExtenso').value = numeroPorExtenso(v);
      }
      if (p.has('proveniente'))
        document.getElementById('provenienteInput').value = p.get('proveniente');
    }

    function numeroPorExtenso(str) {
      const n = parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
      const I = Math.floor(n), C = Math.round((n - I) * 100);
      const U = ['', 'um','dois','três','quatro','cinco','seis','sete','oito','nove','dez','onze','doze','treze','catorze','quinze','dezesseis','dezessete','dezoito','dezenove'];
      const D = ['', '', 'vinte','trinta','quarenta','cinquenta','sessenta','setenta','oitenta','noventa'];
      const E = ['', 'cento','duzentos','trezentos','quatrocentos','quinhentos','seiscentos','setecentos','oitocentos','novecentos'];
      function ex(v) {
        if (v < 20) return U[v];
        if (v < 100) return D[Math.floor(v/10)] + (v%10 ? ' e '+U[v%10] : '');
        if (v === 100) return 'cem';
        const c = Math.floor(v/100), r = v%100;
        return E[c] + (r ? ' e '+ex(r) : '');
      }
      function ext(v) {
        if (v < 1000) return ex(v);
        const mil = Math.floor(v/1000), r = v%1000;
        let s = mil === 1 ? 'mil' : ex(mil)+' mil';
        return r ? s + (r<100 ? ' e ' : ' ') + ex(r) : s;
      }
      const real = ext(I) + (I === 1 ? ' real' : ' reais');
      const centavos = C ? ' e '+ex(C) + (C === 1 ? ' centavo' : ' centavos') : '';
      return real + centavos;
    }

    function setupCanvas() {
      const canvas = document.getElementById('signature-pad');
      const ctx = canvas.getContext('2d');
      let drawing = false;
      function resize() {
        const data = canvas.toDataURL();
        canvas.width = canvas.offsetWidth;
        canvas.height = 120;
        const img = new Image(); img.onload = ()=>ctx.drawImage(img,0,0); img.src = data;
      }
      window.addEventListener('resize', resize);
      resize();
      ['pointerdown','pointermove','pointerup','pointerleave'].forEach(evt => canvas.addEventListener(evt, e => {
        if (evt === 'pointerdown') { drawing = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); }
        if (evt === 'pointermove' && drawing) { ctx.lineTo(e.offsetX, e.offsetY); ctx.strokeStyle='#000'; ctx.lineWidth=2; ctx.stroke(); }
        if (evt === 'pointerup' || evt === 'pointerleave') { drawing = false; }
      }));
      document.getElementById('clear-signature').onclick = () => ctx.clearRect(0,0,canvas.width,canvas.height);
    }

    async function sendToDrive() {
      const sendBtn = document.getElementById('send-button');
      const printBtn = document.getElementById('print-button');
      const clearBtn = document.getElementById('clear-signature');
      sendBtn.style.display = 'none';
      printBtn.style.display = 'none';
      clearBtn.style.display = 'none';
      try {
        const opt = {
          margin: 0,
          filename: `Recibo-${document.getElementById('numeroRecibo').value}.pdf`,
          html2canvas: { scale: 2 },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        const pdfBlob = await html2pdf().set(opt).from(document.getElementById('recibo')).outputPdf('blob');
        const reader = new FileReader();
        reader.onload = async () => {
          const base64 = reader.result.split(',')[1];
          const resp = await fetch(WEB_APP_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify({ fileBase64: base64, filename: opt.filename }) });
          const json = await resp.json();
          alert(json.status === 'OK' ? 'REBIBO ENVIADO COM SUCESSO!' : 'Erro: ' + (json.message || ''));
        };
        reader.readAsDataURL(pdfBlob);
      } catch (e) {
        console.error(e);
        alert('Falha ao enviar: ' + e.message);
      } finally {
        sendBtn.style.display = 'inline-block';
        printBtn.style.display = 'inline-block';
        clearBtn.style.display = 'inline-block';
      }
    }
  </script>
</body>
</html>
